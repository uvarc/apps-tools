#!/bin/bash
# Pull a container and install it as a module through EasyBuild
# Requirements:
#     skopeo - inspect container label without pulling
#     jq     - parse json
#
# Ruoshi Sun
# 2021-03-23 central container dir
# 2020-07-04

if [[ $# -lt 4 || $# -gt 5 ]]; then
    echo "Usage: `basename $0` URI_prefix user app tag [version]"
    echo "             URI_prefix = docker|library|shub|etc."
    echo "                   user = username of repository (if empty, put \"\")"
    echo "                    app = name of repository"
    echo "                    tag = tag of repository"
    echo "                version = Rivanna module version (default: tag)"
    echo
    echo "Pull command:"
    echo "singularity pull app-version.sif URI_prefix://[user/]app:tag"
    exit 1
fi

# parse input
URI_PREFIX=$1
USER=$2
APP=$3
TAG=$4
[ $# -eq 4 ] && VERSION=$TAG || VERSION=$5

SINGULARITY_VERSION=3.7.1
SKOPEO_VERSION=1.1.1

module purge

# constants
HERE=`pwd`

# functions
function exit_if_error {
    echo "+ $1"
    eval $1
    if [ $? -ne 0 ]; then
        echo "Error: $2"
        exit 1
    fi
}

function print_stage {
    echo -e "\033[1;34m==> $1\033[0m"
}

# URI
[ -z "$USER" ] && URI="${URI_PREFIX}://${APP}:${TAG}" || URI="${URI_PREFIX}://${USER}/${APP}:${TAG}"

# singularity
SIF=${APP}-${VERSION}.sif
module load singularity/$SINGULARITY_VERSION easybuild

# check sources
print_stage "Checking sources"
cd $EASYBUILD_SOURCEPATH
SRCDIR=${APP::1}/${APP}
[ -d $SRCDIR ] || {
    print_stage "Creating directory $EASYBUILD_SOURCEPATH/$SRCDIR"
    mkdir -p $SRCDIR
}

cd $SRCDIR
if [ -e $SIF ]; then
    read -p "$SIF already exists. Overwrite? [y/N]" yn
    if [[ $yn =~ ^[Yy]$ ]]; then
        rm $SIF
    else
        SKIP_PULL=true
    fi
    EB_FORCE=true # Module may already exist. Set "eb -f"
fi

# check if container exists and store labels
print_stage "Checking URI"
module load skopeo >/dev/null 2>&1
TMP=$(mktemp)

exit_if_error "$CONTAINERDIR/skopeo-${SKOPEO_VERSION}.sif inspect $URI >$TMP" "container $URI does not exist"

module unload skopeo

# pull container as sif
if [ "$SKIP_PULL" = true ]; then
    print_stage "Pulling container [skipped]"
else
    print_stage "Pulling container"
    exit_if_error "singularity pull $SIF $URI" "failed to pull container"
fi

module unload singularity

# parse labels
print_stage "Parsing labels"
module load jq

for label in HOMEPAGE DESCRIPTION MODULECLASS GPU; do
    eval "$label"='"`cat $TMP | jq -r \".Labels.${label,,}\"`"'
    echo $label="${!label}"
done

module unload jq

# write easyconfig
EB=${APP}-${VERSION}-singularity-${SINGULARITY_VERSION}.eb 

print_stage "Writing easyconfig $HERE/$EB"
cd $HERE

DATE=$(date +%Y-%m-%d)
EB_HEADER="# $DATE generated by container2module script (Ruoshi Sun)"

[ "$GPU" = true ] && USE_GPU="True" || USE_GPU="False"

cat >$EB <<EOF
$EB_HEADER

easyblock = 'EB_SingularityImage'

name = '$APP'
version = '$VERSION'

homepage = '$HOMEPAGE'
description = """
$DESCRIPTION
"""

toolchain = {'name': 'singularity', 'version': '$SINGULARITY_VERSION'}

sources = ['%(name)s-%(version)s.sif']

use_gpu = $USE_GPU

skipsteps = ['sanitycheck']

moduleclass = '$MODULECLASS'
EOF

cat $EB
echo
echo "Run:"
echo "eb $EB"
