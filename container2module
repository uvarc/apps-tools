#!/bin/bash
# Pull a container and install it as a module through EasyBuild
# Ruoshi Sun
# 2020-07-04

if [[ $# -ne 5 && $# -ne 6 ]]; then
    echo "Usage: `basename $0` URI_prefix user app tag version [gpu]"
    echo "where URI_prefix = docker|library|shub|etc."
    echo "      user       = username of repository (if empty, put \"\")"
    echo "      app        = name of repository"
    echo "      tag        = tag of repository"
    echo "      version    = version to be used on Rivanna (may be different from tag)"
    echo "      gpu        = set \"use_gpu = True\" in easyconfig"
    echo
    echo "The pull command is:"
    echo "singularity pull app-version.sif URI_prefix://[user/]app:tag"
    exit 1
fi

# parse input
URI_PREFIX=$1
USER=$2
APP=$3
TAG=$3
VERSION=$4
[ $5 = "gpu" ] && GPU=true || GPU=false

HERE=`pwd`

function exit_if_error {
    echo "+ $1"
    eval "$1"
    if [ $? -ne 0 ]; then
        echo
        echo "Error: $2"
        exit 1
    fi
}

# URI
[ -z "$USER" ] && URI="${URI_PREFIX}://${APP}:${TAG}" || URI="${URI_PREFIX}://${USER}/${APP}:${TAG}"

# singularity
SINGULARITY_VERSION=3.5.2
SIF=${APP}-${VERSION}.sif
module load singularity/$SINGULARITY_VERSION easybuild

# check if source directory exists
echo "== Checking sources"
cd $EASYBUILD_SOURCEPATH
SRCDIR=${APP::1}/${APP}
[ -d $SRCDIR ] || {
    echo "== Creating directory $EASYBUILD_SOURCEPATH/$SRCDIR"
    mkdir -p $SRCDIR
}

# check if sif exists
cd $SRCDIR
if [ -e $SIF ]; then
    read -p "$SIF already exists. Overwrite? [y/N]" yn
    if [[ ! $yn =~ ^[Yy]$ ]]; then
        SKIP_PULL=true
    fi
    EB_FORCE=true # Module may already exist. Set "eb -f"
fi

# pull container as sif
if [ "$SKIP_PULL" = true ]; then
    echo "== Pulling container (skipped)"
else
    echo "== Pulling container"
    exit_if_error "singularity pull $SIF $URI" "failed to pull container"
fi

module unload singularity

# EasyBuild
EB=${APP}-${VERSION}-singularity-${SINGULARITY_VERSION}.eb 
DATE=$(date +%Y-%m-%d)
EB_HEADER="# $DATE generated by container2module script (Ruoshi Sun)"

if [ "$GPU" = true ]; then
    USE_GPU="True"
    RUNCMD="%(toolchain_name)s run --nv ./\$CONTAINERDIR/%(name)s-%(version)s.sif"
else
    USE_GPU="False"
    RUNCMD="./\$CONTAINERDIR/%(name)s-%(version)s.sif"
fi

# write easyconfig
echo "== Writing easyconfig"
cd $HERE

cat >$EB <<EOF
$EB_HEADER

easyblock = 'EB_SingularityImage'

name = '$APP'
version = '$VERSION'

homepage = 'http'
description = """

"""

toolchain = {'name': 'singularity', 'version': '$SINGULARITY_VERSION'}

sources = ['%(name)s-%(version)s.sif']

use_gpu = $USE_GPU
modloadmsg = """To run:
$RUNCMD
"""

sanity_check_paths = {
    'files': ['%(name)s-%(version)s.sif'],
    'dirs': [],
}

moduleclass = 'data'
EOF

cat $EB
echo
echo "== Editing easyconfig (manual)"
echo "Please edit homepage, description, moduleclass in:"
echo "$HERE/$EB"
echo
read -rsn1 -p "Press any key when done"
echo

echo "== EasyBuild"
if [ "$EB_FORCE" = true ]; then 
    exit_if_error "eb $EB -f" "EasyBuild installation failed"
else 
    exit_if_error "eb $EB" "EasyBuild installation failed"
fi

echo
echo "Done!"
