#!/bin/bash
# look for potentially incomplete installations in apps
# criterion:
# - missing *.eb file
#
# Ruoshi Sun
# 2020-02-18

APPDIR=/sfs/applications

if [ $# -eq 0 ]; then
    echo "Usage: `basename $0` YYYYMM [...]"
    exit 1
fi

YYYYMMs=$@

function search_eb {
    search=$1
    incomplete=()
    for i in `echo "$search"`; do
        if [ -d $i -a ! -e $i/easybuild/*.eb ]; then
            incomplete+=( "$i" )
        fi
    done
}

for YYYYMM in $YYYYMMs; do
    echo "[$YYYYMM]"
    for CATEGORY in core compiler mpi toolchains container; do
        case $CATEGORY in
        core|toolchains)
            search="*/*"
            ;;
        compiler|container)
            search="*/*/*/*"
            ;;
        mpi)
            search="*/*/*/*/*/*"
            ;;
        esac

        cd $APPDIR/$YYYYMM/software/standard/$CATEGORY
        search_eb "$search"
        n=${#incomplete[@]}
        N=`echo "$(echo $search)" | wc | awk '{print $2}'`

        echo "$CATEGORY (${n}/${N})"
        if [ $n -gt 0 ]; then
            printf '    %s\n' "${incomplete[@]}"
        fi
    done
    echo
done
