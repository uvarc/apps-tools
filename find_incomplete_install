#!/bin/bash
# look for potentially incomplete installations in apps
# criterion:
# - missing *.eb file
#
# Ruoshi Sun
# 2020-02-18

APPDIR=/sfs/applications

if [ $# -eq 0 ]; then
    echo "Usage: `basename $0` YYYYMM [...]"
    exit 1
fi

YYYYMMs=$@

function search_eb {
    CATEGORY=$1

    case $CATEGORY in
    core|toolchains)
        search="*/*"
        ;;
    compiler|container)
        search="*/*/*/*"
        ;;
    mpi)
        search="*/*/*/*/*/*"
        ;;
    esac

    for i in `echo "$search"`; do
        if [ -d $i -a ! -e $i/easybuild/*.eb ]; then
            echo $i
        fi
    done
}

for YYYYMM in $YYYYMMs; do
    echo "[$YYYYMM]"
    for c in core compiler mpi toolchains container; do
        echo $c
        cd $APPDIR/$YYYYMM/software/standard/$c
        search_eb $c
        echo
    done
done
